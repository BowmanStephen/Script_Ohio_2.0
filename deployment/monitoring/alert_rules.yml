groups:
  - name: cfbd-kpis
    rules:
      - alert: CFBDApiErrorRateHigh
        expr: sum(rate(cfbd_client_requests_total{outcome="error"}[5m]))
              / sum(rate(cfbd_client_requests_total[5m])) > 0.005
        for: 5m
        annotations:
          summary: "CFBD API error rate exceeds 0.5%"
          description: "Investigate credentials, host selection, or upstream outage."
      - alert: CFBDApiLatencyHigh
        expr: histogram_quantile(0.95, sum(rate(cfbd_client_latency_ms_bucket[5m])) by (le)) > 400
        for: 10m
        annotations:
          summary: "CFBD API latency p95 degraded"
          description: "Check network path or throttle settings."
      - alert: CFBDFreshnessLag
        expr: max(cfbd_dataset_freshness_seconds{dataset!=""}) > 900
        for: 15m
        annotations:
          summary: "Dataset freshness exceeds 15 minutes"
          description: "See telemetry to find lagging job."
      - alert: CFBDSubscriptionDown
        expr: cfbd_subscription_heartbeat == 0
        for: 5m
        annotations:
          summary: "GraphQL subscription heartbeats stalled"
          description: "Restart websocket client or fail over."
