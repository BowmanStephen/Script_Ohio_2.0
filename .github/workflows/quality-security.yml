name: Quality & Security Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 6 * * 1"

jobs:
  python-quality:
    name: Python Lint, Type Check, Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt', 'requirements-dev*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Check formatting with Black
        run: black --check agents src scripts

      - name: Ruff lint
        run: ruff check agents src scripts

      - name: Run mypy
        run: mypy --config-file mypy.ini agents src scripts

      - name: Run Pyright
        run: |
          npm install -g pyright@1.1.389
          pyright

      - name: Pytest with coverage
        run: |
          pytest tests agents/tests \
            --cov=agents --cov=src --cov-report=xml --cov-report=term-missing

      - name: Upload Python coverage
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: coverage.xml
          if-no-files-found: error

  frontend-quality:
    name: Frontend Quality Gates
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web_app

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: ESLint
        run: npm run lint

      - name: Type check (tsc)
        run: npm run typecheck

      - name: Run Vitest with coverage
        run: npm run test -- --coverage

      - name: npm audit
        run: npm audit --omit=dev

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage
          path: web_app/coverage

  security-scan:
    name: Dependency Security Scans
    runs-on: ubuntu-latest
    needs: [python-quality]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install scanning tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit safety bandit

      - name: pip-audit
        run: |
          pip-audit \
            -r requirements.txt \
            -r requirements-dev.txt \
            --format json \
            --output pip-audit-report.json

      - name: Safety scan
        run: |
          safety check \
            --file requirements.txt \
            --file requirements-dev.txt \
            --json \
            --full-report \
            --output safety-report.json

      - name: Bandit static analysis
        run: |
          bandit -r agents src scripts \
            -f json \
            -o bandit-report.json

      - name: npm audit (production)
        working-directory: web_app
        run: npm audit --omit=dev --json > ../npm-audit-report.json

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            pip-audit-report.json
            safety-report.json
            bandit-report.json
            npm-audit-report.json

  quality-gates:
    name: Consolidated Quality Gates
    runs-on: ubuntu-latest
    needs: [python-quality, frontend-quality]

    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*coverage"
          merge-multiple: true

      - name: Evaluate coverage thresholds
        run: |
          python - <<'PY'
          import json
          import sys
          import xml.etree.ElementTree as ET
          from pathlib import Path

          MIN_PYTHON_COVERAGE = 0.85
          MIN_WEB_COVERAGE = 0.75

          failures = []

          coverage_xml = Path("coverage.xml")
          if coverage_xml.exists():
              root = ET.parse(coverage_xml).getroot()
              line_rate = float(root.attrib.get("line-rate", 0.0))
              if line_rate < MIN_PYTHON_COVERAGE:
                  failures.append(f"Python coverage {line_rate:.2%} < {MIN_PYTHON_COVERAGE:.0%}")
              else:
                  print(f"âœ… Python coverage {line_rate:.2%}")
          else:
              failures.append("Python coverage report missing")

          web_report = None
          for candidate in (
              Path("web_app/coverage/coverage-final.json"),
              Path("coverage/coverage-final.json"),
          ):
              if candidate.exists():
                  web_report = candidate
                  break

          if web_report:
              with web_report.open() as handle:
                  data = json.load(handle)
              total = data.get("total", {})
              statements = total.get("statements", {})
              pct = statements.get("pct", 0) / 100
              if pct < MIN_WEB_COVERAGE:
                  failures.append(f"Web coverage {pct:.2%} < {MIN_WEB_COVERAGE:.0%}")
              else:
                  print(f"âœ… Web coverage {pct:.2%}")
          else:
              failures.append("Web coverage report missing")

          if failures:
              print("ðŸš¨ Quality gates failed:")
              for failure in failures:
                  print(f" - {failure}")
              sys.exit(1)
          print("âœ… Quality gates satisfied")
          PY

